<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-算法导论" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/25/算法导论/" class="article-date">
  <time datetime="2018-04-25T07:21:27.580Z" itemprop="datePublished">2018-04-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/25/算法导论/">算法导论</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p>字符串处理</p>
<ol>
<li>原地reverse字符串单测</li>
</ol>
</li>
<li><p>树遍历</p>
<ol>
<li>树对称</li>
</ol>
</li>
<li><p>链表</p>
</li>
<li><p>图论</p>
<ul>
<li>邻接矩阵edge方法存储</li>
<li>搜索算法：Dfs,bfs,<strong>Dijkstra</strong>算法</li>
</ul>
</li>
<li><p>数组动态规划</p>
<ol>
<li><p>Climbing Stairs</p>
<p>fibonacci数列 f(n) =f(n-1)+f(n-2)</p>
</li>
<li><p>Min Cost Climbing Stairs</p>
<p>在Climbing Stairs基础上增加了cost，问题分解为</p>
<p>sum[i] 到达i节阶梯的花费，sum[i] = min(sum[i-1]+cost[i-1],sum[i-2]+cost[i-2])</p>
</li>
<li><p>Continuous Subarray Sum</p>
<p>求任意子数组的和是不是等于k的倍数</p>
<p>一个比较巧妙的思路是每个和模k，如果出现一个数之前出现过，即中间的数和为k的倍数</p>
</li>
<li><p>House Robber</p>
<p>动态规划入门，sum[i]表示盗取i获得的最大钱数，sum[i] = max(sum[i-2]+c[i],sum[i-1])</p>
</li>
<li><p>Partition to K Equal Sum Subsets</p>
<p>从数组中找到和为特定值的子数组，貌似没什么特别好的方法，暴力枚举</p>
</li>
<li><p>Counting Bits</p>
<p>统计每个元素的二进制1个数，可以依赖之前的计算结果</p>
<p>f(n) = k if n == 2^k</p>
<p>f(n) = 1 + f(n-2^k)  if 2^k&lt;n&lt;2^k+1 </p>
</li>
<li><p>Split Array Largest Sum</p>
<p>分解为两道题目：</p>
<ul>
<li>给定一个数组int[]nums，份数m，最大值max，需要将数组nums切分为连续的最多m份，每一份的和&lt;=max</li>
<li>Given a lower bound (<em>left</em>), an upper bound (<em>right</em>), an unknown bool array (<em>B</em>), and an API uses <em>i</em> as input and tells you whether <em>B[i]</em> is true. If we know there exists an index <em>k</em>, <strong>that B[i] is false when i &lt; k, and B[i] is true when i &gt;= k</strong>. What is the fastest way to <strong>find this k (the lower bound)?</strong></li>
</ul>
<p>第一问通过贪心算法，不断累加数组，如果超过&gt;max，之前的数组作为一段，并重新开始累加，最多形成m份数组</p>
<p>第二问可以用二分查找方法找到k。    </p>
<p>组合这两个问题，原问题是找到一个数k，满足将原数组切分为m份，并且每一份的和&lt;=k,使得k最小。由于k&gt;=每一份数组的和，即max(nums)&lt;=k&lt;=sum(nums)。</p>
</li>
<li><p>最长有效子数组Longest Valid Parentheses</p>
<p>动态规划：longest[i] 表示i为结尾的最长有效括号对</p>
<p>如果s[i]==’(‘ 则忽略，如果s[i] == ‘)’ 并且s[i - longest[i-1] - 1] == ‘(‘ 则配对成功，长度加二，并且如果i - longest[i-1] - 2也是一个最长子串，则可以拼接成为新的最大子串</p>
<p>if s[i] == ‘(‘ longest[i] = 0;</p>
<p>if s[i] == ‘)’ &amp;&amp; s[i - longest[i-1] - 1] == ‘(‘ then: longest[i] = longest[i-1] + 2 + longest[i-longest[i-1]-2]</p>
<p>​</p>
</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/25/算法导论/" data-id="cjgw0z2dl000tjkbmwvtgxwej" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/algorithm/">algorithm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Divide Two Integers" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/24/Divide Two Integers/" class="article-date">
  <time datetime="2018-04-24T06:51:53.277Z" itemprop="datePublished">2018-04-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/24/Divide Two Integers/">Divide Two Integers</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>整数处理往往涉及溢出，一般的处理方案就是将整数转为long以后进行处理。</p>
<p>判断整数溢出的方式为，如果两个正数相加返回负数，则溢出。如果两个负数相加返回正数则溢出</p>
<h4 id="题目描述："><a href="#题目描述：" class="headerlink" title="题目描述："></a>题目描述：</h4><p><a href="https://leetcode.com/problems/divide-two-integers/description/" target="_blank" rel="noopener">https://leetcode.com/problems/divide-two-integers/description/</a></p>
<h4 id="解题思路："><a href="#解题思路：" class="headerlink" title="解题思路："></a>解题思路：</h4><p>除法无法使用，可以通过加法来模拟，题目中注意的问题是如果每次只是增加divisor，速度过慢，会超时，所以通过加分模拟乘法的方式来加快速度。</p>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">findMultiply</span><span class="params">(<span class="keyword">long</span> dividend, <span class="keyword">long</span> divisor, <span class="keyword">boolean</span> isNegative)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dividend &lt; divisor) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> sum = divisor;</span><br><span class="line">    <span class="keyword">long</span> result = isNegative ? -<span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ((sum + sum) &lt;= dividend) &#123;</span><br><span class="line">        result += result;</span><br><span class="line">        sum += sum;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result + findMultiply(dividend - sum, divisor, isNegative);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">divide</span><span class="params">(<span class="keyword">int</span> dividend, <span class="keyword">int</span> divisor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> ldividend = dividend;</span><br><span class="line">    <span class="keyword">long</span> ldivisor = divisor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ldividend &gt; <span class="number">0</span> &amp;&amp; ldivisor &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        result = findMultiply(ldividend, ldivisor, <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ldividend &lt; <span class="number">0</span> &amp;&amp; ldivisor &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        result = findMultiply(Math.abs(ldividend), Math.abs(ldivisor), <span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ldividend &gt; <span class="number">0</span> &amp;&amp; ldivisor &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        result = findMultiply(Math.abs(ldividend), Math.abs(ldivisor), <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ldividend &lt; <span class="number">0</span> &amp;&amp; ldivisor &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        result = findMultiply(Math.abs(ldividend), Math.abs(ldivisor), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result &gt; Integer.MAX_VALUE) &#123;</span><br><span class="line">        result = Integer.MAX_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public void stringtoint() &#123;</span><br><span class="line"></span><br><span class="line">        assert divide(10, 5) == 2;</span><br><span class="line">        assert divide(42, 5) == 8;</span><br><span class="line">        assert divide(11, 5) == 2;</span><br><span class="line"></span><br><span class="line">        assert divide(-10, -5) == 2;</span><br><span class="line">        assert divide(-11, -5) == 2;</span><br><span class="line">        assert divide(-9, -5) == 1;</span><br><span class="line"></span><br><span class="line">        assert divide(9, -5) == -1;</span><br><span class="line">        assert divide(10, -5) == -2;</span><br><span class="line"></span><br><span class="line">        assert divide(10, -5) == -2;</span><br><span class="line">        assert divide(1000000000, -5) == 1000000000 / -5;</span><br><span class="line"></span><br><span class="line">        assert divide(Integer.MAX_VALUE, 1) == Integer.MAX_VALUE;</span><br><span class="line">        assert divide(Integer.MIN_VALUE, 1) == Integer.MIN_VALUE;</span><br><span class="line">        assert divide(Integer.MAX_VALUE, -1) == Integer.MIN_VALUE + 1;</span><br><span class="line">        assert divide(Integer.MIN_VALUE, -1) == Integer.MAX_VALUE;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/24/Divide Two Integers/" data-id="cjgw0z2cf0000jkbm01q3b4pp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/algorithm/">algorithm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-kata - bulls and cows" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/27/kata - bulls and cows/" class="article-date">
  <time datetime="2018-03-27T01:47:38.093Z" itemprop="datePublished">2018-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/27/kata - bulls and cows/">TDD coding kata - bulls and cows</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><p>Leetcode url</p>
<p><a href="https://leetcode.com/problems/bulls-and-cows/description/" target="_blank" rel="noopener">https://leetcode.com/problems/bulls-and-cows/description/</a></p>
</li>
<li><p>Test Code</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"testing"</span></span><br><span class="line">	<span class="string">"github.com/stretchr/testify/assert"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGuessAllCorrect</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	t.Run(<span class="string">"guess4BullsAndNoCows"</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		ret := getHint(<span class="string">"1111"</span>, <span class="string">"1111"</span>)</span><br><span class="line">		assert.Equal(t, <span class="string">"4A0B"</span>, ret, <span class="string">"guess4BullsAndNoCows failed"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	t.Run(<span class="string">"guessNoBullsAndCows"</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		ret := getHint(<span class="string">"1111"</span>, <span class="string">"2222"</span>)</span><br><span class="line">		assert.Equal(t, <span class="string">"0A0B"</span>, ret, <span class="string">"guessNoBullsAndCows failed"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	t.Run(<span class="string">"guessOneBullAndNoCow"</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		ret := getHint(<span class="string">"1111"</span>, <span class="string">"1222"</span>)</span><br><span class="line">		assert.Equal(t, <span class="string">"1A0B"</span>, ret, <span class="string">"guessOneBullAndNoCow failed"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	t.Run(<span class="string">"guessOneBullAndOneCow"</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		ret := getHint(<span class="string">"1112"</span>, <span class="string">"1323"</span>)</span><br><span class="line">		assert.Equal(t, <span class="string">"1A1B"</span>, ret, <span class="string">"guessOneBullAndOneCow failed"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	t.Run(<span class="string">"guessOneBullAndOneCowWithDuplicateGuessNumber"</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		ret := getHint(<span class="string">"1112"</span>, <span class="string">"1223"</span>)</span><br><span class="line">		assert.Equal(t, <span class="string">"1A1B"</span>, ret, <span class="string">"guessOneBullAndOneCowWithDuplicateGuessNumber failed"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	t.Run(<span class="string">"guessNoBullAndOneCowWithDuplicateGuessNumber"</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		ret := getHint(<span class="string">"1234"</span>, <span class="string">"0111"</span>)</span><br><span class="line">		assert.Equal(t, <span class="string">"0A1B"</span>, ret, <span class="string">"guessNoBullAndOneCowWithDuplicateGuessNumber failed"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	t.Run(<span class="string">"guessNoBullAndFourCowWithDuplicateDigital"</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		ret := getHint(<span class="string">"1122"</span>, <span class="string">"2211"</span>)</span><br><span class="line">		assert.Equal(t, <span class="string">"0A4B"</span>, ret, <span class="string">"guessNoBullAndFourCowWithDuplicateDigital failed"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	t.Run(<span class="string">"guessNoBullAndOneCowWithDuplicatePosition"</span>, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">		ret := getHint(<span class="string">"1122"</span>, <span class="string">"0001"</span>)</span><br><span class="line">		assert.Equal(t, <span class="string">"0A1B"</span>, ret, <span class="string">"guessNoBullAndOneCowWithDuplicatePosition failed"</span>)</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getHint</span><span class="params">(secret, guess <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	A := <span class="number">0</span></span><br><span class="line">	B := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	guessBytes := []<span class="keyword">byte</span>(guess)</span><br><span class="line">	secretBytes := []<span class="keyword">byte</span>(secret)</span><br><span class="line">	guessedByteMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line">	secretByteMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> guestIndex, guestValue := <span class="keyword">range</span> guessBytes &#123;</span><br><span class="line">		<span class="keyword">if</span> guestValue == secretBytes[guestIndex] &#123;</span><br><span class="line">			setGuessAndSecretIndexPair(guessedByteMap, secretByteMap, guestIndex, guestIndex)</span><br><span class="line">			A = increaseBullNumber(A)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> guestIndex, guestValue := <span class="keyword">range</span> guessBytes &#123;</span><br><span class="line">		<span class="keyword">for</span> secretIndex, secretValue := <span class="keyword">range</span> secretBytes &#123;</span><br><span class="line">			<span class="keyword">if</span> guestIndex != secretIndex &amp;&amp; guestValue == secretValue &amp;&amp;</span><br><span class="line">				checkSecretAndGuessIndexUsed(guessedByteMap, secretByteMap, guestIndex, secretIndex) &#123;</span><br><span class="line">				B = increaseCowNumber(B)</span><br><span class="line">				setGuessAndSecretIndexPair(guessedByteMap, secretByteMap, guestIndex, secretIndex)</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%dA%dB"</span>, A, B)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">increaseBullNumber</span><span class="params">(a <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> a + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">increaseCowNumber</span><span class="params">(b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> b + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setGuessAndSecretIndexPair</span><span class="params">(guessedByteMap <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, secretByteMap <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, guestIndex, secretIndex <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	guessedByteMap[guestIndex] = <span class="number">1</span></span><br><span class="line">	secretByteMap[secretIndex] = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkSecretAndGuessIndexUsed</span><span class="params">(guessedByteMap, secretByteMap <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, guestIndex, secretIndex <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> secretByteMap[secretIndex] == <span class="number">0</span> &amp;&amp; guessedByteMap[guestIndex] == <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>思路：遍历guess字符串两边，第一遍遍历产生bull个数，第二遍产生cows个数。需要两个map记录guess和secret被使用过的字符下标，避免重复计算</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/27/kata - bulls and cows/" data-id="cjgw0z2da000cjkbm8bfi0fra" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/algorithm/">algorithm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-微服务认证授权" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/26/微服务认证授权/" class="article-date">
  <time datetime="2018-03-26T06:54:01.924Z" itemprop="datePublished">2018-03-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/26/微服务认证授权/">微服务体系中的认证和授权</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p>认证（authorization）和授权(authentication)的区别</p>
<ul>
<li>认证（authorization）：验证A是A，即A用户输入用户名密码，验证是不是正确</li>
<li>授权（authentication）：认证A是A后，判断A是不是有访问某个url或者某个数据的权限</li>
</ul>
</li>
<li><p>认证有几种方式</p>
<ul>
<li>微信认证</li>
<li>用户名密码</li>
<li>手机号+密码</li>
<li>手机号+验证码</li>
</ul>
</li>
<li><p>认证流程</p>
<ul>
<li><p>微信认证登录</p>
<p>微信登录的方式通过微信认证用户，本地不进行认证。微信认证完成后获取微信用户信息并保存到用户信息模块，信息包括union_id,open_id,昵称等。随后生成jwt token返回给客户端</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95.jpg" alt="微信登录"></p>
<p>SSO和用户存储管理系统分开两个模块，目的是保证SSO相对稳定独立，不和用户管理业务逻辑耦合。用户管理逻辑可能包括：用户查询，用户信息更新等</p>
</li>
<li><p>手机号登录</p>
<p>手机号+密码登录的方式认证用户合法性</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/%E6%89%8B%E6%9C%BA%E5%8F%B7%E7%99%BB%E5%BD%95.jpg" alt="手机号+密码登录"></p>
</li>
</ul>
</li>
<li><p>SSO认证</p>
<p>SSO是个登录门户，他通过调用微信服务或者用户系统认证用户信息合法性。如果合法，生成jwt token保存userid，有效期时间等信息给前端</p>
</li>
<li><p>网关统一认证</p>
<p>微服务体系下，对外接口有个约定：</p>
<ul>
<li>对外暴露服务不能以user_id作为接口参数，必须以token进行传输。</li>
</ul>
<p>如果微服务众多，每个服务都去验证token合法性会过于冗余。所以统一在网关层进行验证，流程如下：</p>
<ul>
<li>对于每一个接口请求，网关会从http_header中获取token，并去sso验证token合法性。如果合法返回token对应的user_id。</li>
<li>网关将user_id放入http_header中传递到resource-service服务。</li>
<li>resource-service通过http_header获取user_id并调用授权服务验证用户是否有权限访问该接口</li>
</ul>
<p><img src="http://ovqe8818i.bkt.clouddn.com/resource-service.jpg" alt="网关认证"></p>
<p>如果对于网关不用每个接口都验证token，可以增加白名单，比如/public，/static路径可以不校验</p>
</li>
<li><p>授权管理</p>
<p>授权是认证后需要做的事情。一般授权管理的模型是基于role的模型，一般是用户属于某个role，role和权限关联。我们在这个基础上面做了扩充。</p>
<ul>
<li>引入了组unit，部门deparment，用户可以属于某个unit，department，role，这些对象和权限permission关联。</li>
<li>权限permission关联一个或者多个资源，资源包括菜单，操作，视图等</li>
<li>权限permission关联一个或者多个动态管理函数funtion（使用js或者groovy写）</li>
<li>权限permission关联模块分类，分类关联平台</li>
</ul>
<p><img src="http://ovqe8818i.bkt.clouddn.com/%E6%8E%88%E6%9D%83%E7%AE%A1%E7%90%86.jpg" alt="授权管理"></p>
<p>​</p>
<p>​</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/26/微服务认证授权/" data-id="cjgw0z2dk000rjkbm7062juy2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/微服务/">微服务</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/系统设计/">系统设计</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-微服务技术选型" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/19/微服务技术选型/" class="article-date">
  <time datetime="2018-03-19T02:51:27.438Z" itemprop="datePublished">2018-03-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/19/微服务技术选型/">微服务技术选型</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="存储模型"><a href="#存储模型" class="headerlink" title="存储模型"></a>存储模型</h3><ol>
<li>关系数据库：mysql，postgresql。主从结构，以文件存储为主，索引使用b+树。适合结构化数据</li>
<li>文档数据库：mongodb<ul>
<li>适合非结构化业务，非常灵活</li>
<li>不支持事务，4.0开始支持</li>
</ul>
</li>
<li>内存数据库：redis（缓存，KV）<ol>
<li>hash：hset key f v</li>
<li>zset：hashtable+skiplist</li>
</ol>
</li>
<li>分布式一致性工具：etcd，zookeeper。KV存储，配置管理，服务发现，分布式锁，通知监听，分布式自增序列等功能<ol>
<li>eted: 使用raft协议。底层KV存储使用bbolt。</li>
<li>zookeeper：zab协议，类似paxos</li>
</ol>
</li>
<li>本地KV：<ul>
<li>LSM模型：leveldb，rocksdb</li>
<li>B树：bolt，bbolt</li>
</ul>
</li>
</ol>
<h3 id="队列选型："><a href="#队列选型：" class="headerlink" title="队列选型："></a>队列选型：</h3><ol>
<li>kafka<ul>
<li>包含：broker，topic，partition，producer，consumer，consumer group</li>
<li>性能较高，顺序读写日志。10万级别/s</li>
<li>单播广播都支持，一个topic可以由一个或多个consumer group消费，每个consumer属于一个consumer group</li>
<li>高可用：主从模式。通过zookeeper选举leader</li>
</ul>
</li>
<li>rabbitmq<ul>
<li>producer，exchanger（topic，direct，fanout），queue，consumer</li>
<li>性能较高，内存+文件。万级别/s</li>
<li>广播单播都支持</li>
<li>高可用：镜像模式，外面加haproxy</li>
</ul>
</li>
</ol>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><ul>
<li>嵌入式</li>
</ul>
<ol>
<li>eureka <ul>
<li>服务端：java</li>
<li>客户端：java，golang，nodejs</li>
</ul>
</li>
<li>consul：<ul>
<li>服务端：golang</li>
<li>客户端：golang，java，nodejs，etc.</li>
</ul>
</li>
<li>etcd，zookeeper:<ul>
<li>分布式一致性工具，可以实现服务发现，需要做一定工作</li>
<li>相比eureka，consul，这类工具比较强大，除了服务发现，还有locking，kv存储等</li>
</ul>
</li>
</ol>
<ul>
<li><p>非入侵</p>
<p>通过容器进行服务发现，一般都是通过Linux网络VIP+IPVS方式</p>
</li>
</ul>
<ol>
<li>docker-swarm</li>
<li>k8s</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/19/微服务技术选型/" data-id="cjgw0z2df000ljkbmaus5yjxf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/microservices/">microservices</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-区块链简介" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/28/区块链简介/" class="article-date">
  <time datetime="2018-02-28T09:35:54.046Z" itemprop="datePublished">2018-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/28/区块链简介/">区块链简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="区块链简介"><a href="#区块链简介" class="headerlink" title="区块链简介"></a>区块链简介</h2><ol>
<li><p>区块链是什么？一句话，它是一种特殊的分布式数据库</p>
</li>
<li><p>区块链特点：去中心化，解决相互信任问题</p>
</li>
<li><p>区块：区块链由一个个区块（block）组成。区块很像数据库的记录，每次写入数据，就是创建一个区块</p>
<p><img src="https://cdn-images-1.medium.com/max/1600/1*pbyFH4U5sO27UE1EjnImoA.png" alt="区块链"></p>
</li>
<li><p>区块内容包括：</p>
<p>版本号：4 字节；<br>上一个区块头的 SHA256 hash 值：链接到一个合法的块上，32 字节；<br>包含的所有验证过的交易的 Merkle 树根的哈希值，32 字节；<br>时间戳timestamp：4 字节；<br>难度指标difficulty：4 字节；<br>Nonce：4 字节，PoW 问题的答案；</p>
<p>10分钟内的所有交易内容</p>
</li>
<li><p>共识机制</p>
<p>解决分布式一致性问题</p>
<p>PoW：Proof of Work。计算一个hash值，小于一个特定的数值。当掌握超过51%的计算，即可控制区块链网络。缺点是慢</p>
<p>PoS：Proof of Stake。权益证明，解决Pow浪费资源问题。获得的权益越多，获得记账的概率越大</p>
<p>PBFT：实用拜占庭容错算法。至少4个节点，n为节点个数，F为可以出错的节点个数，当满足n&gt;3F+1则PBFT算法可以保证节点达到共识。速度比较快</p>
<p>Paxos: 三类角色：proposer，acceptors，learners，也是通过二阶段提交的方式，prepare和accept两个阶段，如果一个proposal被大多数acceptors接受了，该proposal就表示被接受</p>
<p>Raft：简易版paxos，leader，follower，candidate。通过投票选举leader，超过一半的节点认同即可成为leader。follower通过log同步leader数据</p>
</li>
<li><p>区块链合并</p>
<p>如果同一个时刻有多个人在修改一个区块链，取长度最长的那个区块链</p>
</li>
<li><p>安全：通过加密SHA265算法保证</p>
</li>
<li><p>公有链，联盟链，私有链</p>
</li>
<li><p>智能合约：区块链触发器，一堆代码实现的业务逻辑</p>
</li>
<li><p>矿工收益：</p>
<ul>
<li>手续费</li>
<li>奖励的比特币</li>
</ul>
</li>
</ol>
<p><br></p>
<h2 id="比特币："><a href="#比特币：" class="headerlink" title="比特币："></a>比特币：</h2><ol>
<li><p>基于区块链的技术，通过PoW算法达成分布式一致性。通过挖矿产生新的区块记录交易信息</p>
</li>
<li><p>挖矿</p>
<p>目的：产生区块</p>
<p>方法：每个计算节点计算hash值，当hash值小于某个难度系数才有效。区块链保证平均每10分钟能够产生一个有效hash值。难度系数每两周（2016个区块）调整一次，使得能够保持平均每10分钟能够产生一个有效区块</p>
</li>
</ol>
<p><br></p>
<h2 id="区块链、以太坊"><a href="#区块链、以太坊" class="headerlink" title="区块链、以太坊"></a>区块链、以太坊</h2><p>比特币使用了区块链技术，而以太坊是区块链技术的一个实现平台</p>
<p>从交易延伸到了智能合约</p>
<p><br></p>
<h2 id="开放问题"><a href="#开放问题" class="headerlink" title="开放问题"></a>开放问题</h2><p><strong><em>为什么比特币要挖矿</em></strong></p>
<p><strong><em>比特币为什么使用PoW共识算法</em></strong></p>
<p><br></p>
<h2 id="简易版区块链"><a href="#简易版区块链" class="headerlink" title="简易版区块链"></a>简易版区块链</h2><ul>
<li><p>需求1：简单区块链</p>
<ol>
<li><p>设计实现api增加区块（代替挖矿），查看区块链</p>
</li>
<li><p>区块定义：节点编号，生成时间，当前节点hash值，前一个节点hash值，自定义数据(int)</p>
</li>
<li><p>符合区块链的基本原理</p>
<ul>
<li>当前节点hash=hash(previous_hash + index+timestamp+data)</li>
<li>检查区块引用的上一个区块是否存在且有效，即当前节点previoushash=前一个节点hash</li>
<li>当前节点的编号=前一个节点编号+1</li>
</ul>
</li>
<li><p>方便起见，初始化第一个节点为</p>
<p>index=0</p>
<p>Timestamp=0</p>
<p>data=0</p>
<p>hash=”f78b037f6d1ecfc5a00bc7d96858bdc7af9ac8dbf95fdd5736d0f950ab279b9e”</p>
<p>previoushash=””</p>
</li>
</ol>
</li>
</ul>
<ul>
<li><p>需求2：设计P2P区块链</p>
<ol>
<li>在第一个需求基础上，增加P2P通讯接口（增加node，查看nodes）。</li>
<li>可以通过websocket远程通信多个节点，并同步区块链信息。同步规则为：<ul>
<li>当节点A产生一个新的区块，A节点广播新增区块信息到所有节点。如果B节点收到新增区块并且验证可以增加到本地区块链中，则增加。如果不能，需要广播获取网络中最长的区块链并覆盖本地区块链</li>
</ul>
</li>
<li>其他同上</li>
</ol>
</li>
<li><p>需求3：Pow</p>
<ol>
<li>在前两个基础上，增加Pow</li>
</ol>
</li>
</ul>
<p><br></p>
<h2 id="开放问题答案"><a href="#开放问题答案" class="headerlink" title="开放问题答案"></a>开放问题答案</h2><p><strong><em>为什么比特币要挖矿</em></strong></p>
<p>货币的本质是购买力，如果货币被不断增发，其所代表的购买力将不断下降，就会出现通货。比特币原本的目的是为了解决通货的问题。为了保证比特币的稀缺性，比特币作者使用算力来体现稀缺性，所以需要挖矿才能产生比特币</p>
<p><strong><em>比特币为什么使用PoW共识算法</em></strong></p>
<p>因为是公网环境，网络情况不稳定，安全性较差，所以PoW是一种相对公平可以达到一致性的算法，虽然效率较低。相比PoS，PBFT，Raft等算法性能会高很多。</p>
<p><br></p>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><p><a href="http://www.ruanyifeng.com/blog/2017/12/blockchain-tutorial.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2017/12/blockchain-tutorial.html</a></p>
<p><a href="https://medium.com/@lhartikk/a-blockchain-in-200-lines-of-code-963cc1cc0e54" target="_blank" rel="noopener">https://medium.com/@lhartikk/a-blockchain-in-200-lines-of-code-963cc1cc0e54</a></p>
<p><a href="https://medium.com/@mycoralhealth/code-your-own-blockchain-in-less-than-200-lines-of-go-e296282bcffc" target="_blank" rel="noopener">https://medium.com/@mycoralhealth/code-your-own-blockchain-in-less-than-200-lines-of-go-e296282bcffc</a></p>
<p><a href="http://www.infoq.com/cn/articles/bitcoin-and-block-chain-part02" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/bitcoin-and-block-chain-part02</a>  Pow</p>
<p><a href="https://blockchain.info/" target="_blank" rel="noopener">https://blockchain.info/</a></p>
<p><a href="http://www.ey.com/Publication/vwLUAssets/ey-blockchain-platform-research-and-analysis-cn/$FILE/ey-blockchain-platform-research-and-analysis-cn.pdf" target="_blank" rel="noopener">http://www.ey.com/Publication/vwLUAssets/ey-blockchain-platform-research-and-analysis-cn/$FILE/ey-blockchain-platform-research-and-analysis-cn.pdf</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/02/28/区块链简介/" data-id="cjgw0z2di000ojkbmmnclx214" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/区块链/">区块链</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-bash多行注释" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/02/bash多行注释/" class="article-date">
  <time datetime="2018-01-02T02:17:43.654Z" itemprop="datePublished">2018-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/02/bash多行注释/">Bash 多行注释</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Bash-多行注释"><a href="#Bash-多行注释" class="headerlink" title="Bash 多行注释"></a>Bash 多行注释</h3><ul>
<li>传统的C语言多行注释</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">this is a comment</span><br><span class="line">this is a comment again</span><br><span class="line">this is another comment </span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<ul>
<li>bash多行注释</li>
</ul>
<p>那么在bash环境中要怎么做呢？可以这样做：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">:&lt;&lt;\true</span><br><span class="line">  ls</span><br><span class="line">  read</span><br><span class="line">  `read`</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
<p>这里涉及到两个unix知识点</p>
<ul>
<li><p>Here Document</p>
<p>Here Document 是在Linux Shell 中的一种特殊的重定向方式，它的基本的形式如下<br>cmd &lt;&lt; delimiter<br>  Here Document Content<br>delimiter</p>
<p>其作用是将两个 delimiter 之间的内容(Here Document Content 部分) 传递给cmd 作为输入参数</p>
</li>
<li><p>空指令：</p>
<p>:是一个unix命令，含义是do nothing</p>
</li>
</ul>
<p>那么上面这段bash的含义是：以true作为here document的分隔符，其中所有的内容作为输出到空命令：，那么达到的效果是什么都不做，即为注释。那为什么true之前要加一个\,原因是如果不加\，那么here document内容中如果出现\或者`，那么here document转义会失败，所以需要增加\，避免转义失败。</p>
<ul>
<li><p>关闭注释</p>
<p>上面这段bash只修改一行就可以开关注释，要怎么做？</p>
<p>我们知道bash中单行注释通过#，那么如果把here document 注释了需要注释here document头尾两行。如下代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#:&lt;&lt;\true</span><br><span class="line">  ls</span><br><span class="line">  read</span><br><span class="line">  `read`</span><br><span class="line">#true</span><br></pre></td></tr></table></figure>
<p>但是我们代码末尾的分隔符是true，所以其实不注释也没问题，执行不会有任何报错。所以只要注释here document的行首即可，代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#:&lt;&lt;\true</span><br><span class="line">  ls</span><br><span class="line">  read</span><br><span class="line">  `read`</span><br><span class="line">true</span><br></pre></td></tr></table></figure>
<p>​</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/02/bash多行注释/" data-id="cjgw0z2d40007jkbmonri7qu8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bash/">bash</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Mysql 索引入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/07/Mysql 索引入门/" class="article-date">
  <time datetime="2017-11-07T09:17:33.000Z" itemprop="datePublished">2017-11-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/mysql/">mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/07/Mysql 索引入门/">mysql索引入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Mysql索引入门"><a href="#Mysql索引入门" class="headerlink" title="Mysql索引入门"></a>Mysql索引入门</h3><ol>
<li><p>什么是索引</p>
<p>索引用于快速找出在某个列中有一特定值的行</p>
</li>
<li><p>索引类型</p>
<p>大多数MySQL索引(PRIMARY KEY、UNIQUE、INDEX和FULLTEXT)在B树中存储。只是空间列类型的索引使用R-树，并且MEMORY表还支持hash索引</p>
</li>
<li><p>索引越多越好？</p>
<ul>
<li>数据的变更（增删改）都需要维护索引，因此更多的索引意味着<strong>更多的维护成本</strong></li>
<li>更多的索引意味着也需<strong>要更多的空间</strong> （一本100页的书，却有50页目录？）</li>
<li>过小的表，建索引可能会更慢</li>
<li>频繁写入影响性能</li>
</ul>
</li>
<li><p>使用索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">like &apos;xxx%&apos;   -- 可以用索引</span><br><span class="line">Like &apos;%xxx%&apos;  -- 不能用索引</span><br><span class="line">like &apos;%xxx&apos;   -- 不能用索引</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;，&lt;=，=，&gt;，&gt;=，BETWEEN，IN 	-- 可以用索引</span><br><span class="line">&lt;&gt;，not in ，！=则不行  -- 不能用索引</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT `sname` FROM `t_stu` WHERE `age`=20; 	-- 会使用索引</span><br><span class="line">SELECT `sname` FROM `t_stu` WHERE `age`+10=30; 	-- 不会使用索引！！因为所有索引列参与了计算</span><br><span class="line">SELECT `sname` FROM `t_stu` WHERE `age`=30-10;	-- 会使用索引</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT `sname` FROM `stu` WHERE concat(`sname`,&apos;abc&apos;) =&apos;Jaskeyabc&apos;; -- 不会使用索引,因为使用了函数运算,原理与上面相同</span><br><span class="line">SELECT `sname` FROM `stu` WHERE `sname` =concat(&apos;Jaskey&apos;,&apos;abc&apos;); -- 会使用索引</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select * from dept where dname=&apos;jaskey&apos; or loc=&apos;bj&apos; or deptno=45 --如果条件中有or,即使其中有条件带索引也不会使用。换言之,就是要求使用的所有字段,都必须建立索引</span><br><span class="line">可以通过union来替换or</span><br><span class="line">select * from dept where dname=&apos;jaskey&apos; union</span><br><span class="line">select * from dept where loc=&apos;bj&apos; union</span><br><span class="line">select * from dept where deptno=45</span><br></pre></td></tr></table></figure>
</li>
<li><p>什么样的字段适合建索引</p>
<ul>
<li>唯一性太差的字段不适合单独创建索引，即使频繁作为查询条件</li>
<li>较频繁的作为查询条件的字段应该创建索引</li>
</ul>
</li>
<li><p>什么时候用复合索引</p>
<p>where a = x and b =xx 是建立索引a，索引b，索引ab，索引ba？</p>
<p>看区分度</p>
</li>
<li><p>最左前缀原则</p>
<p>复合索引（a,b,c），可以用到索引的情况是</p>
<p>where a=x and b=x and c=x</p>
<p>where a=x and b=x</p>
<p>where a=x</p>
<p>其余where条件都不能用到索引</p>
</li>
<li><p>order by 索引</p>
<p>单独使用order by是不能用索引的，需要配合limit</p>
<p>where+orderby时需要加复合索引，比如where a=x order by b,c需要加（a,b,c）索引</p>
</li>
<li><p>当有多个索引，选择哪个</p>
<p>mysql 会自动选择返回集合小的索引</p>
</li>
<li><p>不要过早优化，除非仔细分析</p>
<p>explain工具</p>
</li>
<li><p>Case Study </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> CREATE TABLEt_cms_comment` (</span><br><span class="line"></span><br><span class="line">  id bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line"></span><br><span class="line">  content text,</span><br><span class="line"></span><br><span class="line">  create_time timestamp(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),</span><br><span class="line"></span><br><span class="line">  platform_id int(11) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  update_time timestamp(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),</span><br><span class="line"></span><br><span class="line">  target_type varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  target_id bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  content_type varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  interaction_type varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  user_id bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  variety varchar(255) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  variety_id bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  create_user bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  deleted int(11) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  update_user bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  audit_state varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  author_type varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  is_top bit(1) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  top_priority bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  audit_user bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  audit_time timestamp NULL DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  re_audit_user bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure>
<p>select * from t_cms_comment where create_time &lt; ‘2017-11-09 10:00:00’ and variety_id=5 and variety=’studio’ order by top_priority desc ,create_time desc, id desc limit 200     —  怎么加索引？</p>
<ul>
<li>where create_time &lt; ‘2017-11-09 10:00:00’ and variety_id=5 and variety=’studio’ </li>
<li>order by : top_priority desc ,create_time desc, id desc</li>
<li>where + order by 复合索引，如果不行，优先考虑对sort建立索引，因为sort比较耗性能</li>
<li>可能索引：(top_priority+create_time+id), (create_time+varierty_id),(variety_id)</li>
</ul>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/11/07/Mysql 索引入门/" data-id="cjgw0z2d20004jkbm9r0waacy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-backend_share" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/26/backend_share/" class="article-date">
  <time datetime="2017-09-26T06:14:03.000Z" itemprop="datePublished">2017-09-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/26/backend_share/">微服务简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1-后端整体服务"><a href="#1-后端整体服务" class="headerlink" title="1.后端整体服务"></a>1.后端整体服务</h4><p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-134104@2x.png" alt="服务简介"></p>
<h4 id="整体服务分层"><a href="#整体服务分层" class="headerlink" title="整体服务分层"></a>整体服务分层</h4><ol>
<li>前端页面渲染</li>
<li>业务逻辑层</li>
<li>服务层</li>
</ol>
<h4 id="我们使用的技术包括："><a href="#我们使用的技术包括：" class="headerlink" title="我们使用的技术包括："></a>我们使用的技术包括：</h4><p>开发：配置管理，服务发现，远程调用，网关，日志追踪</p>
<p>监控：prometheus监控，apm性能管理</p>
<p>部署：docker，k8s, ansible</p>
<p>基础组件：mysql，redis，mqtt，rabbitmq</p>
<h3 id="2-服务管理"><a href="#2-服务管理" class="headerlink" title="2. 服务管理"></a>2. 服务管理</h3><ol>
<li>配置管理</li>
</ol>
<ul>
<li><p>代码配置分离</p>
<p>我们通过git集中化进行配置管理，配置和程序代码分离，即做到一份程序，多份配置，多处部署</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-144742@2x.png" alt="配置管理"></p>
</li>
</ul>
<ul>
<li><p>实时刷新配置</p>
<p>通过springcloud-bus项目，我们可以实时动态热更新运行中的程序配置，避免修改配置需要重新打包发布</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-145050@2x.png" alt="动态刷新"></p>
</li>
<li><p>配置获取</p>
<p>通过域名conf.jinyi999.cn/{项目名称}/{环境} 获取应用相应环境的配置，比如<a href="http://conf.jinyi999.cn/ytx-sso/k8s或者sso项目k8s环境的配置" target="_blank" rel="noopener">http://conf.jinyi999.cn/ytx-sso/k8s或者sso项目k8s环境的配置</a></p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-150127@2x.png" alt="配置"></p>
<p>​</p>
</li>
</ul>
<h4 id="2-服务注册发现"><a href="#2-服务注册发现" class="headerlink" title="2. 服务注册发现"></a>2. 服务注册发现</h4><ul>
<li><p>传统服务管理问题</p>
<p>传统服务通过域名管理，通过nginx代理服务域名，需要管理nginx和后端服务关系，在微服务时代，服务量级会不断增加，通过传统的nginx管理服务十分不便。比如新增节点，减少节点，都需要对nginx进行重新配置。通过获取服务信息也十分困难不便</p>
</li>
</ul>
<ul>
<li><p>服务发现好处</p>
<p>服务发现的好处在于，可以零编码的对所以服务进行动态管理，获取服务信息，如服务ip，端口，监控状态等。我们使用的是eureka进行服务发现管理。</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-152000@2x.png" alt="WX20170901-152000@2x"></p>
</li>
<li><p>服务发现模型</p>
<p>服务发现本身需要保证服务的分布式高可用，所以服务发现本身相对比较复杂。在分布式CAP理论基础上，eureka服务发现使用了AP模型，在网络出现问题时，保证了服务的可用性，牺牲了一致性</p>
</li>
<li><p>eureka高可用</p>
<p>我们部署了三台eureka服务，三个节点两两相互备份，保证服务的高可用性，任意一个节点挂了都不会影响服务的可用性</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-154026@2x.png" alt="WX20170901-154026@2x"></p>
</li>
<li><p>统一管理各自语言服务：包括java服务，nodejs服务，go服务，并且可以不断扩张</p>
</li>
</ul>
<h4 id="3-远程调用"><a href="#3-远程调用" class="headerlink" title="3.远程调用"></a>3.远程调用</h4><ul>
<li>远程调用简称RPC，在我们微服务体系中，我们选用了http作为远程调用协议（后续可以升级为gRpc等方式）。在springcloud体系中，我们使用了feign通过ribbon来进行远程调用。ribbon封装了httpclient或者okhttp，通过eureka获取服务地址并做负载均衡。我们使用了okhttp进行访问，提高http访问效率</li>
</ul>
<ul>
<li><p>重试机制</p>
<p>远程调用需要考虑重试，比如由于网络超时、服务不稳定等原因造成访问失败。ribbon提供的重试机制为：对于所有GET幂等请求进行重试，重试方式是本机重试或者重新选取一个节点重试。相关配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ribbon:</span><br><span class="line">  MaxAutoRetries: 1  			#本机重试一次</span><br><span class="line">  MaxAutoRetriesNextServer: 1	#重新选举一台重试</span><br><span class="line">  okhttp:</span><br><span class="line">    enabled: true				#使用okhttp</span><br><span class="line">    </span><br><span class="line">eureka:</span><br><span class="line">  registry-fetch-interval-seconds: 5	#5s从注册中心获取一次服务信息</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-网关"><a href="#4-网关" class="headerlink" title="4.网关"></a>4.网关</h4><p> 在微服务时间，服务数量相对传统单体应用会增加许多。我们通过统一的网关服务zuul代理访问所有的服务。</p>
<ul>
<li><p>网关好处</p>
<p>统一服务入口，避免客户端调用不同服务</p>
<p>统一日志管理</p>
<p>统一监控</p>
<p>统一权限控制</p>
<p>统一流量控制</p>
<p>通过网关，我们可以做很多工作，后续如蓝绿发布，a/b test等</p>
</li>
</ul>
<h4 id="5-日志追踪"><a href="#5-日志追踪" class="headerlink" title="5.日志追踪"></a>5.日志追踪</h4><p>在单体应用时代，所有服务日志在一个应用中，而在微服务时代，一次请求涉及多个服务，日志追踪就变的十分重要。我们使用springcloud-sleuth组件进行日志追踪管理，所有日志都会有一个traceid，当进行远程调用时，该traceid会被传递到下游服务。我们的日志样例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2017-09-01 16:09:56.828  INFO [zuul-server,e3459faf4e4115d8,e3459faf4e4115d8,false] 9 </span><br><span class="line">--- [nio-8041-exec-1] c.y.f.base.filter.RequestLoggingFilter   : </span><br><span class="line">After request [method=POST,After request [uri=/api/user-center/device/save;payload=&#123;&quot;deviceToken&quot;:&quot;dd6f96fb3a9c10e6f9087d5ab5291e37&quot;,</span><br><span class="line">&quot;deviceId&quot;:&quot;CC2165D8-BADC-476F-8ED8-B71A04CC2E41&quot;,&quot;userId&quot;:9,&quot;os&quot;:&quot;IOS&quot;,&quot;appVersion&quot;:&quot;1.5.0&quot;&#125;],</span><br><span class="line">time=12(ms),code=200]</span><br></pre></td></tr></table></figure>
<p>traceid=e3459faf4e4115d8，同时我们记录了每次请求的耗时和httpcode，方便排查问题</p>
<ul>
<li><p>zipkins</p>
<p>zipkins是一个tracing可视化工具，通过zipkins，我们将所有服务调用链串联起来。</p>
</li>
</ul>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-142910@2x.png" alt="zipkins"></p>
<h3 id="3-部署"><a href="#3-部署" class="headerlink" title="3. 部署"></a>3. 部署</h3><ul>
<li>服务Docker化</li>
</ul>
<p>所有服务使用docker打包集成，提高部署的持续集成、版本控制、可移植性、隔离性和安全性。</p>
<p>开发测试环境所有部署使用自动化，通过gitlab pipeline完成。单测，sonar检查，build，docker镜像部署，上传docker仓库，部署到k8s环境，全部自动化。线上环境部署通过ansible进行自动化</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-142025@2x.png" alt="pipeline"></p>
<h4 id="4-监控"><a href="#4-监控" class="headerlink" title="4. 监控"></a>4. 监控</h4><ul>
<li><p>基于网关的统一监控</p>
<p>微服务架构由于服务较为分散，造成监控不便，我们通过统一的网关收率监控对象，将所有数据存储到prometheus中，通过grafana进行图表绘制以及报警。有任何错误可以在10s内进行报警</p>
</li>
</ul>
<p><img src="http://ovqidxh71.bkt.clouddn.com/Prometheus-Grafana.png" alt="zuul-prometheus"></p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-135323@2x.png" alt="zuul-prometheus"></p>
<ul>
<li>springboot 服务监控</li>
</ul>
<p>我们所有的微服务使用springboot框架开发，集成了actuator模块，自动暴露了/health，/metrics等接口，通过springboot-admin模块，我们集成了eureka获取了所有模块的列表，通过每个模块的/health，/metrics接口获取模块信息。<br>springboot-admin模块页面如下:<br><img src="http://ovqe8818i.bkt.clouddn.com/WX20170907-092757@2x.png" alt="springboot-admin"><br>通过springboot-admin，我们可以实时观察到每个模块是否存活，健康状态</p>
<p>每个模块的内容包括：模块信息，调用情况，环境变量，调用情况<br><img src="http://ovqe8818i.bkt.clouddn.com/WX20170907-092832@2x.png" alt="springboot-admin"><br>比较有用的是模块信息，比如启动时间，内存占用等。</p>
<ul>
<li>docker 监控</li>
</ul>
<p>使用cadvisor+prometheus监控docker容器状态,可以获取所有机器和服务的的cpu，内存，磁盘等使用信息</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-142403@2x.png" alt="docker cadvisor"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/26/backend_share/" data-id="cjgw0z2d60009jkbmvix3fzp6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/系统设计/">系统设计</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-系统调用思考" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/26/系统调用思考/" class="article-date">
  <time datetime="2017-09-26T05:59:48.000Z" itemprop="datePublished">2017-09-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/26/系统调用思考/">系统调用思考</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一般系统都会访问外部系统，比如请求支付，会员卡，营销等各种系统，有时候一次请求需要访问多个下游系统，这种情况下失败是避免不了的。这里总结了几个注意事项</p>
<ol>
<li>访问下游系统必须设置超时时间，一般设置3s，不同业务系统需要进行相应调整</li>
<li>访问下游系统qps必须控制，不能给下游系统压力过大</li>
<li>幂等操作：访问下游失败了，可能是由于网络超时，下游系统已经处理成功。这个时候有两种方式<ol>
<li>下游提供查询接口，通过查询判断是否处理成功</li>
<li>下游提供幂等接口，通过幂等号多次请求下游，下游保证操作幂等</li>
</ol>
</li>
<li>一次请求需要访问多个下游，如果保证多个下游的数据一致性</li>
</ol>
<ul>
<li>通过分布式事务，比较重，而且需要各个下游支持分布式事务接口，比较难实现。</li>
<li>通过二阶段事务方式访问各个下游，要求也是下游系统需要支持二阶段事务协议，也比较难实现。</li>
<li>简单依次访问各个下游，如果某个下游访问失败了，可以进行的操作是：<ul>
<li>简单重试n次，一般是3次。优点是简单，缺点是如果n次不成功，之前访问的系统无法回滚。</li>
<li>如果n次不成功，有效的方案是落异步任务，然后通过任务无限次重试。优点是可以保证最终一致性。缺点是开发成本大，而且需要下游系统支持幂等。如果下游系统不支持幂等怎么办？我们可以自己为下游系统记录幂等信息，比如我们自己记录一个流水表，记录各个下游系统是否访问成功了。如果成功了就不再访问了</li>
<li>如果落异步任务成本太高，怎么办？暂时没想到什么好方法，我能想到的就是客户端不断重试调用服务端。</li>
</ul>
</li>
</ul>
<p><img src="https://leanote.com/api/file/getImage?fileId=577f5d2dab644135ea003fdf" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/26/系统调用思考/" data-id="cjgw0z2dn000vjkbma5zpsup0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rpc/">rpc</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/">bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservices/">microservices</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rpc/">rpc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/区块链/">区块链</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/团队管理/">团队管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开发流程/">开发流程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微服务/">微服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/系统设计/">系统设计</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithm/" style="font-size: 20px;">algorithm</a> <a href="/tags/bash/" style="font-size: 10px;">bash</a> <a href="/tags/microservices/" style="font-size: 10px;">microservices</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/rpc/" style="font-size: 10px;">rpc</a> <a href="/tags/区块链/" style="font-size: 10px;">区块链</a> <a href="/tags/团队管理/" style="font-size: 10px;">团队管理</a> <a href="/tags/开发流程/" style="font-size: 10px;">开发流程</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a> <a href="/tags/系统设计/" style="font-size: 15px;">系统设计</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/04/25/算法导论/">算法导论</a>
          </li>
        
          <li>
            <a href="/2018/04/24/Divide Two Integers/">Divide Two Integers</a>
          </li>
        
          <li>
            <a href="/2018/03/27/kata - bulls and cows/">TDD coding kata - bulls and cows</a>
          </li>
        
          <li>
            <a href="/2018/03/26/微服务认证授权/">微服务体系中的认证和授权</a>
          </li>
        
          <li>
            <a href="/2018/03/19/微服务技术选型/">微服务技术选型</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>