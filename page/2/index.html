<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Mysql 索引入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/07/Mysql 索引入门/" class="article-date">
  <time datetime="2017-11-07T09:17:33.000Z" itemprop="datePublished">2017-11-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/mysql/">mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/07/Mysql 索引入门/">mysql索引入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Mysql索引入门"><a href="#Mysql索引入门" class="headerlink" title="Mysql索引入门"></a>Mysql索引入门</h3><ol>
<li><p>什么是索引</p>
<p>索引用于快速找出在某个列中有一特定值的行</p>
</li>
<li><p>索引类型</p>
<p>大多数MySQL索引(PRIMARY KEY、UNIQUE、INDEX和FULLTEXT)在B树中存储。只是空间列类型的索引使用R-树，并且MEMORY表还支持hash索引</p>
</li>
<li><p>索引越多越好？</p>
<ul>
<li>数据的变更（增删改）都需要维护索引，因此更多的索引意味着<strong>更多的维护成本</strong></li>
<li>更多的索引意味着也需<strong>要更多的空间</strong> （一本100页的书，却有50页目录？）</li>
<li>过小的表，建索引可能会更慢</li>
<li>频繁写入影响性能</li>
</ul>
</li>
<li><p>使用索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">like &apos;xxx%&apos;   -- 可以用索引</span><br><span class="line">Like &apos;%xxx%&apos;  -- 不能用索引</span><br><span class="line">like &apos;%xxx&apos;   -- 不能用索引</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;，&lt;=，=，&gt;，&gt;=，BETWEEN，IN 	-- 可以用索引</span><br><span class="line">&lt;&gt;，not in ，！=则不行  -- 不能用索引</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT `sname` FROM `t_stu` WHERE `age`=20; 	-- 会使用索引</span><br><span class="line">SELECT `sname` FROM `t_stu` WHERE `age`+10=30; 	-- 不会使用索引！！因为所有索引列参与了计算</span><br><span class="line">SELECT `sname` FROM `t_stu` WHERE `age`=30-10;	-- 会使用索引</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT `sname` FROM `stu` WHERE concat(`sname`,&apos;abc&apos;) =&apos;Jaskeyabc&apos;; -- 不会使用索引,因为使用了函数运算,原理与上面相同</span><br><span class="line">SELECT `sname` FROM `stu` WHERE `sname` =concat(&apos;Jaskey&apos;,&apos;abc&apos;); -- 会使用索引</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select * from dept where dname=&apos;jaskey&apos; or loc=&apos;bj&apos; or deptno=45 --如果条件中有or,即使其中有条件带索引也不会使用。换言之,就是要求使用的所有字段,都必须建立索引</span><br><span class="line">可以通过union来替换or</span><br><span class="line">select * from dept where dname=&apos;jaskey&apos; union</span><br><span class="line">select * from dept where loc=&apos;bj&apos; union</span><br><span class="line">select * from dept where deptno=45</span><br></pre></td></tr></table></figure>
</li>
<li><p>什么样的字段适合建索引</p>
<ul>
<li>唯一性太差的字段不适合单独创建索引，即使频繁作为查询条件</li>
<li>较频繁的作为查询条件的字段应该创建索引</li>
</ul>
</li>
<li><p>什么时候用复合索引</p>
<p>where a = x and b =xx 是建立索引a，索引b，索引ab，索引ba？</p>
<p>看区分度</p>
</li>
<li><p>最左前缀原则</p>
<p>复合索引（a,b,c），可以用到索引的情况是</p>
<p>where a=x and b=x and c=x</p>
<p>where a=x and b=x</p>
<p>where a=x</p>
<p>其余where条件都不能用到索引</p>
</li>
<li><p>order by 索引</p>
<p>单独使用order by是不能用索引的，需要配合limit</p>
<p>where+orderby时需要加复合索引，比如where a=x order by b,c需要加（a,b,c）索引</p>
</li>
<li><p>当有多个索引，选择哪个</p>
<p>mysql 会自动选择返回集合小的索引</p>
</li>
<li><p>不要过早优化，除非仔细分析</p>
<p>explain工具</p>
</li>
<li><p>Case Study </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> CREATE TABLEt_cms_comment` (</span><br><span class="line"></span><br><span class="line">  id bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line"></span><br><span class="line">  content text,</span><br><span class="line"></span><br><span class="line">  create_time timestamp(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),</span><br><span class="line"></span><br><span class="line">  platform_id int(11) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  update_time timestamp(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),</span><br><span class="line"></span><br><span class="line">  target_type varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  target_id bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  content_type varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  interaction_type varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  user_id bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  variety varchar(255) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  variety_id bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  create_user bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  deleted int(11) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  update_user bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  audit_state varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  author_type varchar(30) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  is_top bit(1) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  top_priority bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  audit_user bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  audit_time timestamp NULL DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  re_audit_user bigint(20) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">  PRIMARY KEY (id)</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure>
<p>select * from t_cms_comment where create_time &lt; ‘2017-11-09 10:00:00’ and variety_id=5 and variety=’studio’ order by top_priority desc ,create_time desc, id desc limit 200     —  怎么加索引？</p>
<ul>
<li>where create_time &lt; ‘2017-11-09 10:00:00’ and variety_id=5 and variety=’studio’ </li>
<li>order by : top_priority desc ,create_time desc, id desc</li>
<li>where + order by 复合索引，如果不行，优先考虑对sort建立索引，因为sort比较耗性能</li>
<li>可能索引：(top_priority+create_time+id), (create_time+varierty_id),(variety_id)</li>
</ul>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/11/07/Mysql 索引入门/" data-id="cjmmwuty00000djbmrl7qkfhj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-backend_share" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/26/backend_share/" class="article-date">
  <time datetime="2017-09-26T06:14:03.000Z" itemprop="datePublished">2017-09-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/26/backend_share/">微服务简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1-后端整体服务"><a href="#1-后端整体服务" class="headerlink" title="1.后端整体服务"></a>1.后端整体服务</h4><p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-134104@2x.png" alt="服务简介"></p>
<h4 id="整体服务分层"><a href="#整体服务分层" class="headerlink" title="整体服务分层"></a>整体服务分层</h4><ol>
<li>前端页面渲染</li>
<li>业务逻辑层</li>
<li>服务层</li>
</ol>
<h4 id="我们使用的技术包括："><a href="#我们使用的技术包括：" class="headerlink" title="我们使用的技术包括："></a>我们使用的技术包括：</h4><p>开发：配置管理，服务发现，远程调用，网关，日志追踪</p>
<p>监控：prometheus监控，apm性能管理</p>
<p>部署：docker，k8s, ansible</p>
<p>基础组件：mysql，redis，mqtt，rabbitmq</p>
<h3 id="2-服务管理"><a href="#2-服务管理" class="headerlink" title="2. 服务管理"></a>2. 服务管理</h3><ol>
<li>配置管理</li>
</ol>
<ul>
<li><p>代码配置分离</p>
<p>我们通过git集中化进行配置管理，配置和程序代码分离，即做到一份程序，多份配置，多处部署</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-144742@2x.png" alt="配置管理"></p>
</li>
</ul>
<ul>
<li><p>实时刷新配置</p>
<p>通过springcloud-bus项目，我们可以实时动态热更新运行中的程序配置，避免修改配置需要重新打包发布</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-145050@2x.png" alt="动态刷新"></p>
</li>
<li><p>配置获取</p>
<p>通过域名conf.jinyi999.cn/{项目名称}/{环境} 获取应用相应环境的配置，比如<a href="http://conf.jinyi999.cn/ytx-sso/k8s或者sso项目k8s环境的配置" target="_blank" rel="noopener">http://conf.jinyi999.cn/ytx-sso/k8s或者sso项目k8s环境的配置</a></p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-150127@2x.png" alt="配置"></p>
<p>​</p>
</li>
</ul>
<h4 id="2-服务注册发现"><a href="#2-服务注册发现" class="headerlink" title="2. 服务注册发现"></a>2. 服务注册发现</h4><ul>
<li><p>传统服务管理问题</p>
<p>传统服务通过域名管理，通过nginx代理服务域名，需要管理nginx和后端服务关系，在微服务时代，服务量级会不断增加，通过传统的nginx管理服务十分不便。比如新增节点，减少节点，都需要对nginx进行重新配置。通过获取服务信息也十分困难不便</p>
</li>
</ul>
<ul>
<li><p>服务发现好处</p>
<p>服务发现的好处在于，可以零编码的对所以服务进行动态管理，获取服务信息，如服务ip，端口，监控状态等。我们使用的是eureka进行服务发现管理。</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-152000@2x.png" alt="WX20170901-152000@2x"></p>
</li>
<li><p>服务发现模型</p>
<p>服务发现本身需要保证服务的分布式高可用，所以服务发现本身相对比较复杂。在分布式CAP理论基础上，eureka服务发现使用了AP模型，在网络出现问题时，保证了服务的可用性，牺牲了一致性</p>
</li>
<li><p>eureka高可用</p>
<p>我们部署了三台eureka服务，三个节点两两相互备份，保证服务的高可用性，任意一个节点挂了都不会影响服务的可用性</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20170901-154026@2x.png" alt="WX20170901-154026@2x"></p>
</li>
<li><p>统一管理各自语言服务：包括java服务，nodejs服务，go服务，并且可以不断扩张</p>
</li>
</ul>
<h4 id="3-远程调用"><a href="#3-远程调用" class="headerlink" title="3.远程调用"></a>3.远程调用</h4><ul>
<li>远程调用简称RPC，在我们微服务体系中，我们选用了http作为远程调用协议（后续可以升级为gRpc等方式）。在springcloud体系中，我们使用了feign通过ribbon来进行远程调用。ribbon封装了httpclient或者okhttp，通过eureka获取服务地址并做负载均衡。我们使用了okhttp进行访问，提高http访问效率</li>
</ul>
<ul>
<li><p>重试机制</p>
<p>远程调用需要考虑重试，比如由于网络超时、服务不稳定等原因造成访问失败。ribbon提供的重试机制为：对于所有GET幂等请求进行重试，重试方式是本机重试或者重新选取一个节点重试。相关配置为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ribbon:</span><br><span class="line">  MaxAutoRetries: 1  			#本机重试一次</span><br><span class="line">  MaxAutoRetriesNextServer: 1	#重新选举一台重试</span><br><span class="line">  okhttp:</span><br><span class="line">    enabled: true				#使用okhttp</span><br><span class="line">    </span><br><span class="line">eureka:</span><br><span class="line">  registry-fetch-interval-seconds: 5	#5s从注册中心获取一次服务信息</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-网关"><a href="#4-网关" class="headerlink" title="4.网关"></a>4.网关</h4><p> 在微服务时间，服务数量相对传统单体应用会增加许多。我们通过统一的网关服务zuul代理访问所有的服务。</p>
<ul>
<li><p>网关好处</p>
<p>统一服务入口，避免客户端调用不同服务</p>
<p>统一日志管理</p>
<p>统一监控</p>
<p>统一权限控制</p>
<p>统一流量控制</p>
<p>通过网关，我们可以做很多工作，后续如蓝绿发布，a/b test等</p>
</li>
</ul>
<h4 id="5-日志追踪"><a href="#5-日志追踪" class="headerlink" title="5.日志追踪"></a>5.日志追踪</h4><p>在单体应用时代，所有服务日志在一个应用中，而在微服务时代，一次请求涉及多个服务，日志追踪就变的十分重要。我们使用springcloud-sleuth组件进行日志追踪管理，所有日志都会有一个traceid，当进行远程调用时，该traceid会被传递到下游服务。我们的日志样例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2017-09-01 16:09:56.828  INFO [zuul-server,e3459faf4e4115d8,e3459faf4e4115d8,false] 9 </span><br><span class="line">--- [nio-8041-exec-1] c.y.f.base.filter.RequestLoggingFilter   : </span><br><span class="line">After request [method=POST,After request [uri=/api/user-center/device/save;payload=&#123;&quot;deviceToken&quot;:&quot;dd6f96fb3a9c10e6f9087d5ab5291e37&quot;,</span><br><span class="line">&quot;deviceId&quot;:&quot;CC2165D8-BADC-476F-8ED8-B71A04CC2E41&quot;,&quot;userId&quot;:9,&quot;os&quot;:&quot;IOS&quot;,&quot;appVersion&quot;:&quot;1.5.0&quot;&#125;],</span><br><span class="line">time=12(ms),code=200]</span><br></pre></td></tr></table></figure>
<p>traceid=e3459faf4e4115d8，同时我们记录了每次请求的耗时和httpcode，方便排查问题</p>
<ul>
<li><p>zipkins</p>
<p>zipkins是一个tracing可视化工具，通过zipkins，我们将所有服务调用链串联起来。</p>
</li>
</ul>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-142910@2x.png" alt="zipkins"></p>
<h3 id="3-部署"><a href="#3-部署" class="headerlink" title="3. 部署"></a>3. 部署</h3><ul>
<li>服务Docker化</li>
</ul>
<p>所有服务使用docker打包集成，提高部署的持续集成、版本控制、可移植性、隔离性和安全性。</p>
<p>开发测试环境所有部署使用自动化，通过gitlab pipeline完成。单测，sonar检查，build，docker镜像部署，上传docker仓库，部署到k8s环境，全部自动化。线上环境部署通过ansible进行自动化</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-142025@2x.png" alt="pipeline"></p>
<h4 id="4-监控"><a href="#4-监控" class="headerlink" title="4. 监控"></a>4. 监控</h4><ul>
<li><p>基于网关的统一监控</p>
<p>微服务架构由于服务较为分散，造成监控不便，我们通过统一的网关收率监控对象，将所有数据存储到prometheus中，通过grafana进行图表绘制以及报警。有任何错误可以在10s内进行报警</p>
</li>
</ul>
<p><img src="http://ovqidxh71.bkt.clouddn.com/Prometheus-Grafana.png" alt="zuul-prometheus"></p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-135323@2x.png" alt="zuul-prometheus"></p>
<ul>
<li>springboot 服务监控</li>
</ul>
<p>我们所有的微服务使用springboot框架开发，集成了actuator模块，自动暴露了/health，/metrics等接口，通过springboot-admin模块，我们集成了eureka获取了所有模块的列表，通过每个模块的/health，/metrics接口获取模块信息。<br>springboot-admin模块页面如下:<br><img src="http://ovqe8818i.bkt.clouddn.com/WX20170907-092757@2x.png" alt="springboot-admin"><br>通过springboot-admin，我们可以实时观察到每个模块是否存活，健康状态</p>
<p>每个模块的内容包括：模块信息，调用情况，环境变量，调用情况<br><img src="http://ovqe8818i.bkt.clouddn.com/WX20170907-092832@2x.png" alt="springboot-admin"><br>比较有用的是模块信息，比如启动时间，内存占用等。</p>
<ul>
<li>docker 监控</li>
</ul>
<p>使用cadvisor+prometheus监控docker容器状态,可以获取所有机器和服务的的cpu，内存，磁盘等使用信息</p>
<p><img src="http://ovqe8818i.bkt.clouddn.com/WX20171227-142403@2x.png" alt="docker cadvisor"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/26/backend_share/" data-id="cjmmwuty50001djbm99rgv0zi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/系统设计/">系统设计</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-系统调用思考" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/26/系统调用思考/" class="article-date">
  <time datetime="2017-09-26T05:59:48.000Z" itemprop="datePublished">2017-09-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/26/系统调用思考/">系统调用思考</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一般系统都会访问外部系统，比如请求支付，会员卡，营销等各种系统，有时候一次请求需要访问多个下游系统，这种情况下失败是避免不了的。这里总结了几个注意事项</p>
<ol>
<li>访问下游系统必须设置超时时间，一般设置3s，不同业务系统需要进行相应调整</li>
<li>访问下游系统qps必须控制，不能给下游系统压力过大</li>
<li>幂等操作：访问下游失败了，可能是由于网络超时，下游系统已经处理成功。这个时候有两种方式<ol>
<li>下游提供查询接口，通过查询判断是否处理成功</li>
<li>下游提供幂等接口，通过幂等号多次请求下游，下游保证操作幂等</li>
</ol>
</li>
<li>一次请求需要访问多个下游，如果保证多个下游的数据一致性</li>
</ol>
<ul>
<li>通过分布式事务，比较重，而且需要各个下游支持分布式事务接口，比较难实现。</li>
<li>通过二阶段事务方式访问各个下游，要求也是下游系统需要支持二阶段事务协议，也比较难实现。</li>
<li>简单依次访问各个下游，如果某个下游访问失败了，可以进行的操作是：<ul>
<li>简单重试n次，一般是3次。优点是简单，缺点是如果n次不成功，之前访问的系统无法回滚。</li>
<li>如果n次不成功，有效的方案是落异步任务，然后通过任务无限次重试。优点是可以保证最终一致性。缺点是开发成本大，而且需要下游系统支持幂等。如果下游系统不支持幂等怎么办？我们可以自己为下游系统记录幂等信息，比如我们自己记录一个流水表，记录各个下游系统是否访问成功了。如果成功了就不再访问了</li>
<li>如果落异步任务成本太高，怎么办？暂时没想到什么好方法，我能想到的就是客户端不断重试调用服务端。</li>
</ul>
</li>
</ul>
<p><img src="https://leanote.com/api/file/getImage?fileId=577f5d2dab644135ea003fdf" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/26/系统调用思考/" data-id="cjmmwutyy000vdjbmnftqumey" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rpc/">rpc</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-我脑海中的优秀技术团队" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/26/我脑海中的优秀技术团队/" class="article-date">
  <time datetime="2017-09-26T05:59:31.000Z" itemprop="datePublished">2017-09-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/26/我脑海中的优秀技术团队/">我脑海中的优秀技术团队</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>文中的“我”，其实不是一个单纯的角色，它可能会包含多层含义，不管是我作为一个团队的管理者，还是我作为一名技术团队的普通员工，都会对自己的团队有一些期许，一些定义，一些要求，而这就是今天我们要谈论的话题。希望这些思考能够对管理者或者求职者有些帮助。</p>
<p>团队的首先组成就是人，那我理想中的技术团队中的人应该是怎样的呢？作为团队的负责人，其实对于人这方面的把关我一直是非常严格的，对于进入到我团队里的成员，通常需要有以下品质，这就是我对技术人的理解。</p>
<h3 id="1-好奇心。"><a href="#1-好奇心。" class="headerlink" title="1.好奇心。"></a>1.好奇心。</h3><p>你为什么做技术？一些人是为了糊口，一些人只是不知道自己能做什么，而另外一群人，则是因为好奇心，对未知领域的探索，用技术来做很多神奇的事情，例如炫酷的动画？碉炸的算法？人工智能？游戏？物理引擎？漂亮惊艳的页面？想想你是不是因为这些技术而义无反顾的冲入编程大军的。我觉得这种编程才能持续的做下去，而不是捞一笔就走的心态，或者想着靠编程实现财务自由。有些同学在做技术一段时间之后，会开始迷茫，我觉得这时候回过头去看看你的初衷非常重要，如果你的初衷是平庸的，那我觉得你不适合做这行，如果是你的初衷是用技术探索应用价值，那我觉得你可以顺着这个思路想一想你的现在的价值点在何处？对于这个问题，前几天我发的一个朋友圈挺有代表性，这里贴出来：</p>
<p><img src="https://leanote.com/api/file/getImage?fileId=579af872ab644135ea02d17e" alt="img"></p>
<h3 id="2-持之以恒的学习。"><a href="#2-持之以恒的学习。" class="headerlink" title="2.持之以恒的学习。"></a>2.持之以恒的学习。</h3><p>我面试的时候通常会特别关注这一点，有时候如果实在看不到一个人对于持续学习的热情，我甚至直接生硬的问对方，“你业余时间会做些什么跟技术相关的事情”，然后得到的回答，通常是“看书”“看论坛”“看源码”。其实这就是敷衍了事了，这些事情只是一个程序员最基本的一些学习方法，我其实想知道的是，你是如何“持续学习”的，你看过一篇文章之后，对于其中涉及的一些知识点，你如何去强化？如何去实践？甚至如何引入到工作中来？你的工作或者是项目都做得平平无奇，那你看书看论坛都是在看什么呢？看了之后又解决了什么问题？</p>
<h3 id="3-分析解决问题的方式。"><a href="#3-分析解决问题的方式。" class="headerlink" title="3.分析解决问题的方式。"></a>3.分析解决问题的方式。</h3><p>最基本的，你在遇到技术难题的时候，如何解决？google？爆栈网？这些是最基本的，你如何判别一个解决方案的正确性？你如何一步一步分析问题？如何debug你的代码？然后，解决问题之后，你做了什么思考？是否是你的知识面有问题，需要系统补充下某个方面的技术点？你是否研究了它周边的知识？写一篇博客，备忘顺便分享给网友？这里又涉及到知识管理的方面。总之每次遇到问题其实都是一次对你的知识面的扩充时机，最终这些都会变成你的经验。在工作多年之后，这些潜移默化的知识会让你能够快速对一个问题作出判断，会在你脑海中形成一套体系，帮助你快速分析和解决问题，不管是你的方向是架构师，还是业务leader，都需要这些能力。</p>
<p>通常，你做事的方式态度，就决定了你的未来。</p>
<p>为什么我们需要一个团队中的成员具备这些素质？最终目的都是通过这些细节发现一个人的潜力：好奇心决定了你能在技术这条道路上走多久；学习方式决定了你能够在这条道路上越走越高；而解决问题的方式则决定了你能否形成方法论，成为一位真正的资深工程师。</p>
<p>除了上述的三点，对于团队中的人，作为一名普通员工，我还期望有这些关键字：</p>
<ul>
<li>乐于分享，让我可以被动扩充知识面；</li>
<li>和善真实，不为人情世故操心专心做个写代码的美男子；</li>
<li>牛逼哄哄，让我大开眼界的牛人那是最好不过的，光听那些名词就足够我出去吹半天了，对于开阔思路视野有奇效；</li>
</ul>
<p>人满足需求了，接着讲我理想中的团队是什么样的第二部分：事。</p>
<h3 id="1-团队是否在朝着一个更好的方向成长？"><a href="#1-团队是否在朝着一个更好的方向成长？" class="headerlink" title="1.团队是否在朝着一个更好的方向成长？"></a>1.团队是否在朝着一个更好的方向成长？</h3><p>我见过很多团队，基本没有“管理”。所谓管理，不是说有个老大管着你，指挥你做这个做那个，而是你这个团队是否有“目标”“规划”“预期”。就如最近面试的一些比较优秀的同学一样，他非常关注我们团队的“管理”，会提出一堆关于此方面的问题，这就是他对团队的一种期许，你的团队是单纯的实现业务？还是有所规划？你理想中的团队架构是如何的？人员分配如何？技术栈如何？规范如何？流程如何？现在有何不足，作何改进？这些其实就是对“管理”的拷问。一个有管理思路的团队，经得起这些拷问。而这些拷问，其实关注点主要就是你的团队是在健康成长，还是放养或者原地踏步？如果进入没有方向的团队，恐怕自身的成长也不会有大的进步。</p>
<h3 id="2-团队做事方式是否规范？"><a href="#2-团队做事方式是否规范？" class="headerlink" title="2.团队做事方式是否规范？"></a>2.团队做事方式是否规范？</h3><p>近一年，我对团队管理最大的方法论也是指导方针，就是规范化。这里的规范化有几种含义。</p>
<ul>
<li>代码规范，这个不用多说，最基本也是最容易达成的，方法可以有eslint等，加上定期的代码review，以及团队内的规范文档等。</li>
<li>方法规范，如何引入新技术？多人开发如何进行？如何保障代码可用性？如何保障发布安全？如何有效利用日志？等等，这些问题都需要形成方法论，有一套流程来保障。例如引入新技术，我们需要 调研试用 - 产出优劣报告 - 产出脚手架 - 多人review脚手架 - 分享+文档 - 新项目试验 - 问题总结分享 - 优化 - 全面投入使用，过程中会要求一些产出，目的都是为了评估好优劣，并且形成一套规范，而不是随意引入一些不可控的技术。上面提及的其他问题，我们都会形成自己的一套规范，落地分享和文档，跟踪执行。这就是团队规范的方法论。</li>
<li>流程规范，一个需求如何产生？如何评估其用户价值和可行性？如何进入开发手中？如何排期？是否有完善的项目管理流程？测试发布如何进行？一个团队的开发如果是乱哄哄没有标准秩序的话，开发会很累，这些其实是项目经理的职责，从开始对需求的把关，到产品经理的把关，到交互视觉把关，到技术方案排期评估，到联调跟进测试发布。做好不易，做不好大家就会很累。</li>
</ul>
<p>规范化的最终目的，一个是提高开发效率，另一个是确保团队开发的可持续性，减少“坑”出现的几率。这些问题通常是创业公司技术团队的通病。</p>
<h3 id="3-共同成长和价值定位"><a href="#3-共同成长和价值定位" class="headerlink" title="3. 共同成长和价值定位"></a>3. 共同成长和价值定位</h3><p>以我团队为例，最近在做一个事情，全公司公用组件的开发，这个事情我不准备让负责架构的同学去做，我将其分解为两部分： 架构组的事情：制定组件规范，制定脚手架，把关代码质量，出标准组件的实例，推动计划进行，文档和组件索引网站等。 业务组的事情：根据架构组的周边和规范分工实现组件。</p>
<p>我希望通过这样的分工达成两件事情：架构组发挥其作用让事情朝着正确的方向前进；业务组的每位同学都能知道一个标准组件是怎样产出的，都了解npm是如何管理组件的，组件的周期维护是如何的，更通过严格的review通过制度来让大家共同成长。 可以看到这件事情的三个意义：一，让大家共同成长；二，大家各司所致，找到自己在整件事情中的价值定位；三，事情本身推动了团队开发效率，这是其最基本的价值。</p>
<p>作为一个个人，其实对团队的期望大体还有：</p>
<ul>
<li>有足够的挑战，有机会接触各种问题并解决以此获得经验积累。</li>
<li>团队认可我的价值，而不是把我当成工具来使用。</li>
<li>团队有足够的成长空间，对自己有个清晰的定位。</li>
</ul>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>其实今天还跟大家讲，为什么做分享，很难做一些方法论或者是管理思路的分享？一个是因为还不够成熟，大家都在摸索；另一个重要的原因是，很多方法论其实就是一句话或者几句话，更重要的是执行到位，否则说出来都会很虚，但是团队到了一定阶段之后，一定要有目标和方法论，否则还是原始的行军状态，大家都会迷茫，内耗也会非常高。其实这些总结也是挺虚的，但是算是我内心对团队和人的一些见解。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/26/我脑海中的优秀技术团队/" data-id="cjmmwutzc001edjbmmavsib8i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/团队管理/">团队管理</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前后端开发职责" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/26/前后端开发职责/" class="article-date">
  <time datetime="2017-09-26T05:58:08.000Z" itemprop="datePublished">2017-09-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/26/前后端开发职责/">前后端开发职责</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>前端同学和我在讨论什么功能应该放在后端完成，什么工作应该放在前端完成。</p>
<h1 id="想法"><a href="#想法" class="headerlink" title="想法"></a>想法</h1><ul>
<li>传统的开发模式是后端负责业务逻辑，然后通过模板填充数据的方式返回html给前端显示，前端就只要负责样式设计即可。这种模式的缺点是后端太重，既要负责业务，又要负责显示，前端样式改了，后端也要跟着改，整体效率低下。</li>
<li>随之产生的是前后端分离开发模式，即MVC，目的是解决后端负责数据和业务，前端负责显示，通过Controller进行衔接。但是同样有个问题，即Controller的工作范围，如果和以往一样，controller负责将所有业务数据封装完成，View就是简单的显示数据，这样的好处相比原有的模式只是在于后端不用知道前端样式，只负责返回数据，而模板渲染的工作放到了前端。</li>
<li>那是不是前端就只是负责显示数据？我觉得不应该这样的，前端也是应该有相应的业务逻辑存在的。那哪些业务逻辑应该放在前端，哪些必须放在后端，其实很难定义。有些业务必须放在后端，比如数据校验，安全分析，权限控制这些是要放在后端。但是有些业务是两边都可以做的，比如菜单栏显示，菜单栏里面的数据如果是固定的，那这个数据应该维护在前端还是后端，其实前后端都可以。</li>
</ul>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><h3 id="我觉得针对这个问题我的思路是两点"><a href="#我觉得针对这个问题我的思路是两点" class="headerlink" title="我觉得针对这个问题我的思路是两点"></a>我觉得针对这个问题我的思路是两点</h3><ul>
<li>从整体最优的角度去思考问题，从开发成本，维护成本角度看，放在哪里是最优的。</li>
<li>前后端开发语言的特点考虑，前端出现的优势就是快速开发，相比后端java，js更加轻，开发效率更高，所以我个人建议是将一些独立的业务逻辑移到前端，而不是放在后端。而后端java的优势在于性能，安全，强大的框架以及各种成熟的中间件，所以相对复杂的业务流程需要放到后端。</li>
</ul>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><ul>
<li>后端注重数据，前端注重展示，有时候边界不是特别清晰，需要从整体考虑收益，而不是单从前端或者后端角度考虑问题。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/26/前后端开发职责/" data-id="cjmmwutyv000rdjbm8qm6ifoi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/开发流程/">开发流程</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mysql性能入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/26/mysql性能入门/" class="article-date">
  <time datetime="2017-09-26T05:57:58.000Z" itemprop="datePublished">2017-09-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/mysql/">mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/26/mysql性能入门/">mysql性能入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><p>left join，right join，inner join，select in</p>
<p>最基本的sql语句，连表查询性能并没有想得那么差。尽量避免大表连小表的操作。</p>
</li>
<li><p>锁</p>
<p>mysql的锁有很多类，主要区别在于两点</p>
<ul>
<li>锁粒度</li>
<li>互斥性</li>
</ul>
<p>mysql有一下几类锁</p>
<ol>
<li>Shared and Exclusive Locks：读写锁</li>
<li>Intention Locks：意向锁：表或者行级别锁<ol>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/select.html" target="_blank" rel="noopener">SELECT … LOCK IN SHARE MODE</a> IS锁。读锁</li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/select.html" target="_blank" rel="noopener">SELECT … FOR UPDATE</a> IX锁。写锁</li>
</ol>
</li>
<li>行级锁：用于锁定某一行数据，粒度</li>
<li>gap索引: 范围锁，a gap between index records, or a lock on the gap before the first or after the last index record。在read_repeatable级别有效，read_commited无效</li>
<li>Next-Key Locks: 行锁+gap锁，在read_repeatable级别有效，read_commited无效</li>
<li>Insert Intention Locks: 插入索引</li>
</ol>
</li>
<li><p>事务</p>
<ul>
<li>隔离级别<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_read-uncommitted" target="_blank" rel="noopener">READ UNCOMMITTED</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_read-committed" target="_blank" rel="noopener">READ COMMITTED</a> 阿里云默认，性能好些。不适用gap锁。在扫描数据的时候，会自动释放不符合条件的行锁</li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_repeatable-read" target="_blank" rel="noopener">REPEATABLE READ</a> innodb默认级别，mvcc，使用next-key lock</li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_serializable" target="_blank" rel="noopener">SERIALIZABLE</a> 串行化</li>
</ul>
</li>
<li>Locking Reads<ul>
<li>share mode：SELECT … LOCK IN SHARE MODE。共享读锁</li>
<li>exclusive mode：SELECT … FOR UPDATE。排他锁</li>
</ul>
</li>
</ul>
</li>
<li><p>索引：</p>
<ol>
<li>聚簇索引：索引和数据一起存储，读取效率高</li>
<li>二级索引：存储聚簇索引，读两次磁盘</li>
<li>主键uuid vs auto_increment bigint：二级索引存的是主键值，uuid太大。读取磁盘速度慢。索引不连续</li>
</ol>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/26/mysql性能入门/" data-id="cjmmwutyl000edjbmjxugzd14" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-algorithm-stock" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/11/algorithm-stock/" class="article-date">
  <time datetime="2017-09-11T07:43:28.000Z" itemprop="datePublished">2017-09-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/algorithm/">algorithm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/11/algorithm-stock/">best time to buy and sell stock</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h4 id="1-Best-Time-to-Buy-and-Sell-Stock"><a href="#1-Best-Time-to-Buy-and-Sell-Stock" class="headerlink" title="1. Best Time to Buy and Sell Stock"></a>1. Best Time to Buy and Sell Stock</h4><p>Say you have an array for which the <em>i</em>th element is the price of a given stock on day <em>i</em>.</p>
<p>If you were only permitted to complete at most one transaction (ie, buy one and sell one share of the stock), design an algorithm to find the maximum profit.</p>
<p><strong>Example 1:</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Input: [<span class="number">7</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">4</span>]</span><br><span class="line">Output: <span class="number">5</span></span><br><span class="line"></span><br><span class="line">max. difference = <span class="number">6</span><span class="number">-1</span> = <span class="number">5</span> (not <span class="number">7</span><span class="number">-1</span> = <span class="number">6</span>, as selling price needs to be larger than buying price)</span><br></pre></td></tr></table></figure>
<p><strong>Example 2:</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Input: [<span class="number">7</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">1</span>]</span><br><span class="line">Output: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">In this <span class="keyword">case</span>, no transaction is done, i.e. max profit = <span class="number">0.</span></span><br></pre></td></tr></table></figure>
<p><strong>Answer:</strong></p>
<p>for each time i with price = prices[i], we should find the minimum prices whose time j &lt; i </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MaxProfit</span><span class="params">(prices []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	min := math.MaxInt32</span><br><span class="line">	max := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, x := <span class="keyword">range</span> prices &#123;</span><br><span class="line">		temp := x - min</span><br><span class="line">		<span class="keyword">if</span> temp &gt; max &#123;</span><br><span class="line">			max = temp</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> x &lt; min &#123;</span><br><span class="line">			min = x</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> max</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-Best-Time-to-Buy-and-Sell-Stock-II"><a href="#2-Best-Time-to-Buy-and-Sell-Stock-II" class="headerlink" title="2. Best Time to Buy and Sell Stock II"></a>2. Best Time to Buy and Sell Stock II</h4><p>Say you have an array for whichthe <em>i</em>th elementis the price of a given stock on day <em>i</em>.</p>
<p>Design an algorithm to find the maximum profit. You may completeas many transactions as you like (ie, buy one and sell one share of the stockmultiple times). However, you may not engage in multiple transactions at thesame time (ie, you must sell the stock before you buy again).</p>
<p>Example：</p>
<p>Input: [7, 1, 5,3, 6, 4]</p>
<p>Output: 7</p>
<p>Input: [7, 6, 4,3, 1]</p>
<p>Output: 0</p>
<p><strong>Answer:</strong></p>
<p>since we can do many transaction as we want, then we just need find every close valley and peak in the curve.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MaxprofileWithMultitransaction</span><span class="params">(prices []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	profile := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(prices); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> prices[i] &gt; prices[i<span class="number">-1</span>] &#123;</span><br><span class="line">			profile += prices[i] - prices[i<span class="number">-1</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> profile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-Best-Time-to-Buy-and-Sell-Stock-III"><a href="#3-Best-Time-to-Buy-and-Sell-Stock-III" class="headerlink" title="3.Best Time to Buy and Sell Stock III"></a>3.Best Time to Buy and Sell Stock III</h4><p>Say you have an array for which the <em>i</em>th element is the price of a given stock on day <em>i</em>.</p>
<p>Design an algorithm to find the maximum profit. You may complete at most <em>two</em> transactions.</p>
<p><strong>Note:</strong><br>You may not engage in multiple transactions at the same time (ie, you must sell the stock before you buy again).</p>
<p><strong>Answer:</strong></p>
<p>DP problem, prof[i] is the max profile with up to r transactions before time i.</p>
<p>m = max profile with up to r-1 transaction and prices[i] as buying price in the next transaction at time i</p>
<p>prof[i] = max(prof[i-1],prices[i]+m)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> prices == <span class="literal">nil</span> || <span class="built_in">len</span>(prices) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	n := <span class="built_in">len</span>(prices)</span><br><span class="line">	prof := <span class="built_in">make</span>([]<span class="keyword">int</span>, n, n)</span><br><span class="line">	<span class="keyword">for</span> r := <span class="number">0</span>; r &lt; <span class="number">2</span>; r++ &#123;</span><br><span class="line">		m := prof[<span class="number">0</span>] - prices[<span class="number">0</span>]</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(prices); i++ &#123;</span><br><span class="line">			m = max(m, prof[i]-prices[i])</span><br><span class="line">			prof[i] = max(prof[i<span class="number">-1</span>], prices[i]+m)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> prof[n<span class="number">-1</span>]</span><br></pre></td></tr></table></figure>
<h4 id="4-Best-Time-to-Buy-and-Sell-Stock-IV"><a href="#4-Best-Time-to-Buy-and-Sell-Stock-IV" class="headerlink" title="4.Best Time to Buy and Sell Stock IV"></a>4.Best Time to Buy and Sell Stock IV</h4><p>Say you have an array for which the <em>i</em>th element is the price of a given stock on day <em>i</em>.</p>
<p>Design an algorithm to find the maximum profit. You may complete at most <strong>k</strong> transactions.</p>
<p><strong>Note:</strong><br>You may not engage in multiple transactions at the same time (ie, you must sell the stock before you buy again).</p>
<p><strong>Answer:</strong></p>
<p>DP problem </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prof[r][i] = max(prof[r][i<span class="number">-1</span>],prices[i]+m) <span class="comment">// max(profile with no transaction at time i,profile with transaction at time i)</span></span><br><span class="line">m = max(m,prof[r<span class="number">-1</span>][i<span class="number">-1</span>]-prices[i]) <span class="comment">// max profile with r-1 transaction at time i-1 and buying price = prices[i]</span></span><br></pre></td></tr></table></figure>
<p>代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MaxProfitWithKTransactionDP 动态规划版本</span></span><br><span class="line"><span class="comment">// prof[r][j] 表示j时刻，最多r次交易可以获得的最大收益</span></span><br><span class="line"><span class="comment">// m = max(prof[r-1][j-1]-prices[j],m) 表示r-1笔交易情况下，j-1时刻的收益减去j时刻的价格的最大值</span></span><br><span class="line"><span class="comment">// m意义是基于r-1笔交易收益为prof[r-1][t]的前提下，找到一个低点买入，即需要找到一个时刻t，使得prof[r-1][t-1]-prices[t]值最大，这样才能在后续高点卖出，是的整体收益最大化</span></span><br><span class="line"><span class="comment">// 由于交易笔数k可能比较大，远远大于prices的长度，即这样交易笔数不在重要，只要有价差就可以买入卖出，所以当k&gt;len(prices)/2时，可以直接退化至任意笔操作</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MaxProfitWithKTransactionDP</span><span class="params">(k <span class="keyword">int</span>, prices []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> prices == <span class="literal">nil</span> || <span class="built_in">len</span>(prices) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> k &gt; <span class="built_in">len</span>(prices)/<span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> quickSlove(prices)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	n := <span class="built_in">len</span>(prices)</span><br><span class="line">	prof := <span class="built_in">make</span>([][]<span class="keyword">int</span>, k+<span class="number">1</span>, k+<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; k+<span class="number">1</span>; i++ &#123;</span><br><span class="line">		prof[i] = <span class="built_in">make</span>([]<span class="keyword">int</span>, n, n)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> r := <span class="number">1</span>; r &lt;= k; r++ &#123;</span><br><span class="line">		m := prof[r][<span class="number">0</span>] - prices[<span class="number">0</span>]</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(prices); i++ &#123;</span><br><span class="line">			prof[r][i] = max(prof[r][i<span class="number">-1</span>], prices[i]+m)</span><br><span class="line">			m = max(m, prof[r<span class="number">-1</span>][i<span class="number">-1</span>]-prices[i])</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> prof[k][n<span class="number">-1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">max</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> a &gt; b &#123;</span><br><span class="line">		<span class="keyword">return</span> a</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">quickSlove</span><span class="params">(prices []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	profile := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(prices); i++ &#123;</span><br><span class="line">		<span class="keyword">if</span> prices[i] &gt; prices[i<span class="number">-1</span>] &#123;</span><br><span class="line">			profile += prices[i] - prices[i<span class="number">-1</span>]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> profile</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/11/algorithm-stock/" data-id="cjmmwutyh0009djbmltwcwyfp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/algorithm/">algorithm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/09/04/hello-world/" class="article-date">
  <time datetime="2017-09-04T01:47:07.000Z" itemprop="datePublished">2017-09-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/09/04/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/09/04/hello-world/" data-id="cjmmwutyb0004djbm0pzwuoo9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/algorithm/">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/">bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/microservices/">microservices</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rpc/">rpc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/system-design/">system design</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/区块链/">区块链</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/团队管理/">团队管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/开发流程/">开发流程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微服务/">微服务</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/系统设计/">系统设计</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/algorithm/" style="font-size: 20px;">algorithm</a> <a href="/tags/bash/" style="font-size: 10px;">bash</a> <a href="/tags/microservices/" style="font-size: 10px;">microservices</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/rpc/" style="font-size: 10px;">rpc</a> <a href="/tags/system-design/" style="font-size: 10px;">system design</a> <a href="/tags/区块链/" style="font-size: 10px;">区块链</a> <a href="/tags/团队管理/" style="font-size: 10px;">团队管理</a> <a href="/tags/开发流程/" style="font-size: 10px;">开发流程</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/系统设计/" style="font-size: 15px;">系统设计</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/07/10/微服务网关设计/">微服务网关设计</a>
          </li>
        
          <li>
            <a href="/2018/06/22/redis rate limit/">限流ratelimit</a>
          </li>
        
          <li>
            <a href="/2018/05/28/点赞设计/">点赞、任务模式设计</a>
          </li>
        
          <li>
            <a href="/2018/04/25/算法导论/">算法导论</a>
          </li>
        
          <li>
            <a href="/2018/04/24/Divide Two Integers/">Divide Two Integers</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>